# Linux 二级文件系统模拟器

## 1. 系统概述

Linux 二级文件系统模拟器是一个简单的文件系统实现，模拟了 Linux 文件系统的基本功能。该系统支持用户管理、文件和目录操作、权限控制等功能。

## 2. 编译与运行

### 2.1 编译

在项目目录下执行以下命令编译系统：

```bash
make
```

这将生成可执行文件 `filesystem`。

### 2.2 运行

编译完成后，执行以下命令运行系统：

```bash
./filesystem
```

首次运行时，系统会自动创建一个名为 `disk.img` 的磁盘映像文件，并初始化文件系统。

## 3. 用户管理

### 3.1 默认用户

系统初始化时会创建一个默认的 root 用户：
- 用户名：root
- 密码：root

### 3.2 用户登录

```
login <username> <password>
```

示例：
```
login root root
```

### 3.3 用户登出

```
logout
```

### 3.4 创建新用户（仅限 root 用户）

```
adduser <username> <password>
```

示例：
```
adduser user1 password123
```

## 4. 文件和目录操作

### 4.1 列出当前目录内容

```
dir
```

输出格式：
```
名称            类型    所有者    权限    大小    创建时间
file1           f       root      rwx     10      2023-05-20 14:30
dir1            d       root      rwx     0       2023-05-20 14:35
```

### 4.2 创建文件

```
create <filename>
```

示例：
```
create myfile.txt
```

### 4.3 创建目录

```
mkdir <dirname>
```

示例：
```
mkdir mydir
```

### 4.4 删除文件或目录

```
delete <filename>
```

示例：
```
delete myfile.txt
```

注意：只能删除空目录。

### 4.5 切换目录

```
cd <dirname>
```

特殊目录标识：
- `..` - 上级目录
- `.` - 当前目录
- `/` - 根目录

示例：
```
cd mydir
cd ..
cd /
```

### 4.6 显示文件信息

```
stat <filename>
```

示例：
```
stat myfile.txt
```

### 4.7 复制文件

```
copy <source> <destination>
```

示例：
```
copy file1.txt file2.txt
```

### 4.8 重命名文件

```
rename <oldname> <newname>
```

示例：
```
rename oldfile.txt newfile.txt
```

## 5. 文件内容操作

### 5.1 打开文件

```
open <filename>
```

成功后会返回一个文件描述符（fd），用于后续的读写操作。

示例：
```
open myfile.txt
```

### 5.2 关闭文件

```
close <fd>
```

示例：
```
close 0
```

### 5.3 读取文件内容

```
read <fd> <size>
```

示例：
```
read 0 100
```

### 5.4 写入文件内容

```
write <fd> <content>
```

示例：
```
write 0 "Hello, world!"
```

### 5.5 追加写入文件内容

```
append <filename> <content>
```

示例：
```
append myfile.txt "This text will be appended."
```

## 6. 权限管理

### 6.1 修改文件权限

```
chmod <filename> <permissions>
```

权限格式为三个字符，分别代表读(r)、写(w)、执行(x)权限。如果没有某个权限，用"-"表示。

示例：
```
chmod myfile.txt rwx
chmod myfile.txt r--
```

## 7. 系统操作

### 7.1 显示帮助信息

```
help
```

### 7.2 退出系统

```
exit
```

### 7.3 文件系统一致性检查

```
fsck
```

检查并修复文件系统中的错误，如无效的 inode 引用、未标记使用的数据块等。

### 7.4 磁盘使用情况统计

```
du
```

显示文件系统的使用情况，包括 inode 和数据块的使用情况，以及按用户统计的文件数量和大小。

### 7.5 文件搜索

```
find <pattern>
```

搜索文件系统中符合指定模式的文件和目录。支持简单的通配符 * 匹配。

示例：
```
find *.txt
find doc*
```

## 8. 文件系统限制

- 最大文件名长度：28 字符
- 最大用户名长度：20 字符
- 最大密码长度：20 字符
- 最大 inode 数量：128
- 最大数据块数量：1024
- 最大用户数量：16
- 最大同时打开文件数：16
- 单个文件最大大小：512 字节（一个数据块）

## 9. 权限规则

- root 用户（uid=0）拥有所有权限
- 普通用户只能访问自己创建的文件，或者有相应权限的文件
- 文件权限分为读(r)、写(w)、执行(x)三种
- 只有文件所有者或 root 用户可以修改文件权限
- 目录需要有执行(x)权限才能进入

## 10. 示例会话

```
fs> login root root
登录成功，欢迎 root!

fs> mkdir documents
目录创建成功！

fs> cd documents
已切换到目录：documents

fs> create note.txt
文件创建成功！

fs> open note.txt
文件打开成功，文件描述符为：0

fs> write 0 "This is a test file."
成功写入 19 字节。

fs> close 0
文件已关闭。

fs> append note.txt " Adding more content."
成功追加 21 字节到文件。

fs> dir
当前目录: documents
名称            类型    所有者    权限    大小    创建时间
note.txt        f       root      rwx     40      2023-05-20 15:10

fs> find *.txt
搜索结果：
名称            类型    所有者    路径
note.txt        f       root      /documents/note.txt
共找到 1 个匹配项。

fs> rename note.txt document.txt
文件重命名成功！

fs> dir
当前目录: documents
名称            类型    所有者    权限    大小    创建时间
document.txt    f       root      rwx     40      2023-05-20 15:10

fs> du
磁盘使用情况统计：
总inode数量: 128
已使用inode: 2 (1.6%)
空闲inode: 126 (98.4%)

总数据块数量: 1024
已使用数据块: 2 (0.2%)
空闲数据块: 1022 (99.8%)

文件总数: 1
目录总数: 1
文件系统总大小: 524288 字节
已使用空间: 40 字节 (0.0%)

按用户统计：
用户名          文件数  目录数  总大小(字节)
root            1       1       40

fs> cd ..
已切换到上级目录。

fs> fsck
开始文件系统一致性检查...
文件系统检查完成，未发现错误。

fs> exit
文件系统已安全退出。
```

## 11. 故障排除

### 11.1 常见错误

- "请先登录！" - 需要先使用 login 命令登录系统
- "权限不足" - 当前用户没有执行该操作的权限
- "文件不存在" - 指定的文件或目录不存在
- "目录非空，无法删除" - 只能删除空目录
- "文件已打开，请先关闭" - 删除文件前需要先关闭它

### 11.2 重置文件系统

如果文件系统出现问题，可以删除 disk.img 文件并重新运行程序：

```bash
rm disk.img
./filesystem
```

这将重新初始化文件系统。

## 12. 高级功能

### 12.1 文件追加写入

`append` 命令允许直接向文件末尾追加内容，无需手动打开、定位和关闭文件。

### 12.2 文件系统一致性检查

`fsck` 命令检查文件系统的一致性，包括：
- 检查 inode 位图与实际 inode 使用情况是否一致
- 检查数据块位图与实际数据块使用情况是否一致
- 检查目录结构的一致性
- 自动修复发现的错误

### 12.3 文件搜索

`find` 命令支持使用通配符搜索文件系统中的文件和目录，并显示完整路径。

### 12.4 文件重命名

`rename` 命令允许重命名文件或目录，同时保持其他属性不变。

### 12.5 磁盘使用情况统计

`du` 命令提供详细的磁盘使用情况统计，包括：
- inode 和数据块的使用情况
- 文件和目录的总数
- 按用户统计的文件数量和大小

## 13. 开发信息

本系统使用 C 语言开发，模拟了简单的 Linux 文件系统结构，包括超级块、inode、数据块等概念。系统将所有数据保存在磁盘映像文件中，支持持久化存储。

### 13.1 主要数据结构

- 超级块：存储文件系统的基本信息
- inode：存储文件的元数据
- 数据块：存储文件的实际内容
- 位图：跟踪 inode 和数据块的使用情况

### 13.2 文件系统布局

磁盘映像文件的布局如下：
1. 超级块
2. inode 位图
3. 数据块位图
4. inode 表
5. 数据块区域

### 13.3 扩展可能性

该系统可以进一步扩展，添加更多功能，如：
- 多级目录支持
- 符号链接和硬链接
- 文件压缩和解压缩
- 文件系统备份和恢复
- 访问控制列表（ACL）
- 文件系统加密
